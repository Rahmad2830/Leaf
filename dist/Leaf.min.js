var w={},i=new WeakMap,h=!1,l=new Set,d=new Set;function q(e,o){w[e]=o}function $(){h||(h=!0,queueMicrotask(()=>{h=!1,d.forEach(e=>{e.isConnected||f(e,"disconnect")}),l.forEach(e=>{e.isConnected&&f(e,"connect")}),l.clear(),d.clear()}))}function b(e){let o=new Proxy({},{get:(c,n)=>e.querySelector(`[data-target="${String(n)}"]`)}),t=new Proxy({},{get:(c,n)=>e.querySelectorAll(`[data-target="${String(n)}"]`)});return new Proxy({},{get:(c,n)=>n==="all"?t:o[n]})}function f(e,o){let t=e.dataset.scope,c=w[t];if(!c){console.error(`Scope ${t} not found`);return}let n=i.get(e);if(o==="connect"){if(n=c({root:e,targets:b(e),values:new Proxy({},{get:(g,r)=>e.dataset[r],set:(g,r,m)=>(e.dataset[r]=m,!0)})}),!n){console.error(`[Leaf.js] Scope "${t}" does not return an object. Make sure there is a "return {}" at the end`);return}i.set(e,n),typeof n.connect=="function"&&n.connect()}else o==="disconnect"&&n&&(typeof n.disconnect=="function"&&n.disconnect(),i.delete(e))}var _=new MutationObserver(e=>{e.forEach(o=>{o.addedNodes.forEach(t=>{t.nodeType===1&&(t.matches("[data-scope]")&&l.add(t),t.querySelectorAll("[data-scope]").forEach(c=>l.add(c)))}),o.removedNodes.forEach(t=>{t.nodeType===1&&(t.matches("[data-scope]")&&d.add(t),t.querySelectorAll("[data-scope]").forEach(c=>d.add(c)))})}),$()});function x(){_.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("[data-scope]").forEach(o=>f(o,"connect")),["click","submit","input","change","focus","blur","keydown","pointerdown"].forEach(o=>{document.addEventListener(o,t=>{let c=t.target.closest(`[data-action*="${o}->"]`);if(!c)return;c.dataset.action.split(/\s+/).filter(r=>r.startsWith(`${o}->`)).forEach(r=>{let[m,u]=r.split("->").map(a=>a.trim()),s=c.closest("[data-scope]");if(!s)return;let y=s.dataset.scope;i.has(s)||f(s,"connect");let S={element:c,event:t,params:new Proxy({},{get:(a,p)=>c.dataset[p],set:(a,p,v)=>(c.dataset[p]=v,!0)})},E=i.get(s);E[u]||console.warn(`scope:${y} method "${u}" not found`);try{E[u](S)}catch(a){console.error(`[scope:${y}] ${u}() failed`,a)}})},{capture:!0})})}document.addEventListener("DOMContentLoaded",x);export{q as defineScope};
