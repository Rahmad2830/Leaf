(()=>{function u(e,t,o=document){o.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}))}function E(e){try{return new URL(e,location.href).pathname}catch{return e}}var y={headers:{},fetchOpt:{}},h={},m=new Map;async function p(e,t={}){let o=E(e),a=h[o]||{},{method:s,body:c,headers:l={},type:r="text",fetchOpt:i={},meta:n={}}=t,d=`${o}:${s}`;m.has(d)&&m.get(d).abort();let w=new AbortController;m.set(d,w);let A=c&&typeof c=="object"&&!(c instanceof FormData),O=s!=="GET"&&c!==void 0,L={method:s,headers:{...A?{"Content-Type":"application/json"}:{},Accept:r==="json"?"application/json":"text/html",...y.headers,...a.headers||{},...l},signal:w.signal,...y.fetchOpt,...a.fetchOpt||{},...i};O&&(L.body=A?JSON.stringify(c):c),u("z:before-request",{meta:n},n.el);try{let f=await fetch(e,L);if(!f.ok)throw new Error(await f.text());if(u("z:request-success",{meta:n},n.el),r==="text")return await f.text();if(r==="json")return await f.json();throw new Error(`Response type "${r}" not supported`)}catch(f){if(u("z:request-error",{meta:n},n.el),f.name==="AbortError")return;throw new Error(`Request Failed ${f.message}`)}finally{m.get(d)===w&&m.delete(d),u("z:after-request",{meta:n},n.el)}}p.inject=({headers:e={},fetchOpt:t={}})=>{Object.assign(y.headers,e),Object.assign(y.fetchOpt,t)};p.special=(e,t={})=>{let o=E(e);h[o]||(h[o]={headers:{},fetchOpt:{}}),Object.assign(h[o].headers,t.headers||{}),Object.assign(h[o].fetchOpt,t.fetchOpt||{})};p.clearSpecial=e=>delete h[E(e)];function T(e){let t=document.querySelectorAll("[z-swap]");if(!t.length)return;let o=document.createRange().createContextualFragment(e);t.forEach(a=>{let s=a.getAttribute("z-swap"),[c,l]=s.split(":").map(n=>n.trim()),r=o.querySelector(`[z-swap="${s}"]`);if(!r)return;u("z:before-swap",{el:a,mode:l},a);let i=a;if(l){let n=r.childNodes.length?Array.from(r.childNodes).map(d=>d.cloneNode(!0)):[];if(n.length)switch(l){case"append":a.append(...n);break;case"prepend":a.prepend(...n);break;case"after":a.after(...n);break;case"before":a.before(...n);break;default:throw new Error(`mode ${l} is not exist`)}}else{let n=r.cloneNode(!0);a.replaceWith(n),i=n}u("z:after-swap",{el:i,mode:l},i)})}function q(e){let t=new DOMParser().parseFromString(e,"text/html");function o(i){return i.getAttribute("name")||i.getAttribute("property")||i.getAttribute("http-equiv")||(i.hasAttribute("charset")?"charset":null)}let a=Array.from(document.head.querySelectorAll("meta")),s=Array.from(t.head.querySelectorAll("meta")),c=new Map;a.forEach(i=>{let n=o(i);n&&c.set(n,i)}),s.forEach(i=>{let n=o(i);if(!n)return;let d=c.get(n);d?(d.replaceWith(i.cloneNode(!0)),c.delete(n)):document.head.append(i.cloneNode(!0))}),c.forEach(i=>i.remove());let l=t.body,r=t.title;u("z:before-navigation",{},document),document.body.replaceWith(l),document.title=r||document.title,u("z:after-navigation",{},document)}async function g(e={}){let t;if(e.body!=null&&(t=e.body),!e.url||!e.method){console.error("Request requires url and method",e);return}let o=await p(e.url,{method:e.method,body:t,meta:{el:e.el,url:e.url,method:e.method}});o&&(e.swapType==="partial"&&T(o),e.swapType==="fullpage"&&(e.fromPopState||history.pushState(null,"",e.url),q(o)))}async function b(e){let t,o,a=null,s=[];if(e.__zLoading)return;e.__zLoading=!0;let c=e.getAttribute("z-loading"),l=c?document.querySelectorAll(c):[];if(l.length&&l.forEach(r=>r.classList.add("z-process")),e.setAttribute("aria-busy","true"),e.tagName==="FORM"){if(s=e.querySelectorAll("[type='submit']"),s.length&&s.forEach(r=>r.disabled=!0),t=e.action,o=(e.method||"GET").toUpperCase(),o==="GET"){let r=new URL(e.action,location.href),i=new FormData(e);for(let[n,d]of i)r.searchParams.set(n,d);t=r.toString()}o==="POST"&&(a=new FormData(e))}e.tagName==="A"&&(t=e.href,o="GET");try{await g({url:t,method:o,body:a,el:e,swapType:"partial"})}catch(r){console.error("Request Failed",r)}finally{l.length&&l.forEach(r=>r.classList.remove("z-process")),e.__zLoading=!1,e.removeAttribute("aria-busy"),s.length&&s.forEach(r=>r.disabled=!1)}}async function z(e){let t,o="GET";if(t=e.href,new URL(location.href).href!==new URL(t).href)try{await g({url:t,el:e,method:o,swapType:"fullpage"})}catch(a){console.error("Request Failed",a)}}async function S(e=document){try{await g({url:location.href,method:"GET",swapType:"fullpage",el:e,fromPopState:!0})}catch(t){console.error("Popstate failed",t)}}function v(e,t){let o=t.closest("form[z-ajax], a[z-ajax]");if(!o)return;if(o.getAttribute("z-ajax")==="live".toLowerCase()){if(o.tagName==="A"){console.error("live action is only available on FORM Element");return}if(o.tagName==="FORM"){if(!t.name||t.type==="file")return;if((o.method||"GET").toUpperCase()!=="GET"){console.error("livesearch only support GET method");return}if(e.isComposing)return;if(e.type==="input"&&(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)){clearTimeout(o.__timerDebounce),o.__timerDebounce=setTimeout(function(){o.requestSubmit()},500);return}if(e.type==="change"){o.requestSubmit();return}}}}function x(e=document){e.querySelectorAll('[z-ajax="load"]').forEach(o=>{if(!o.__zLoaded){if(o.__zLoaded=!0,o.tagName==="FORM"){if((o.method||"GET").toUpperCase()!=="GET"){console.error("z-ajax='load' only supports GET method");return}b(o)}o.tagName==="A"&&z(o)}})}function j(){if(!document.head.querySelector("#z-core-style")){let t=document.createElement("style");t.id="z-core-style",t.textContent=".z-loader { display: none; } .z-loader.z-process { display: inline-block !important; }",document.head.append(t)}document.addEventListener("click",async function(t){if(t.metaKey||t.ctrlKey||t.shiftKey||t.altKey||t.button!==0)return;let o=t.target.closest("a[z-ajax]");if(o){t.preventDefault(),await b(o);return}let a=t.target.closest("a[z-nav]");if(a){t.preventDefault(),await z(a);return}}),document.addEventListener("submit",async function(t){let o=t.target.closest("form[z-ajax]");o&&(t.preventDefault(),await b(o))}),document.addEventListener("input",async function(t){let o=t.target;v(t,o)}),document.addEventListener("change",function(t){let o=t.target;v(t,o)}),document.addEventListener("z:after-navigation",function(t){x(document)}),window.addEventListener("popstate",async()=>{await S(document)}),x(document)}window.$fetch=p;document.addEventListener("DOMContentLoaded",()=>{j()});})();
